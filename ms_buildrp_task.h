#ifndef __ms_buildrp_task_h__
#define __ms_buildrp_task_h__

#include "ms_layers_abstract.h"
#include "ms_config.h"
#include "ms_defines.h"
#include <maf/utils/Observable.h>
#include <mutex>
#include <atomic>

using namespace maf::signal_slots;

class MalwareScanBuildRP{
public:
    MalwareScanBuildRP(std::promise<ms_int> srcPromise) :  _totalTask(-1), _tellEngineToStop(std::move(srcPromise)){
        _pScanConfig = MalwareScanConfig::instance()->getConfig();
    }
    ~MalwareScanBuildRP();

    ms_rc start(const MSDict& inDict, MSDict& outDict);
    
    MSDict onNewFileScanned( MSDict file_result);
    ms_rc  onScanFinished();
    ms_rc  onNewFileProcessed(const size_t& fileSize);
    ms_rc  onNewBlockResult( MSDict file_result);
    ms_rc  onErrorResult( MSDict file_result);

    ms_rc  isBlockedResult(const MSDict &result, ms_bool &isBlock);
    ms_rc  isErrorResult(const MSDict &result, ms_bool &isBlock);

    ms_rc  filterIgnoredResults();    
    ms_rc  buildScanReport();
    ms_rc  createSOTReport(MSDict& sotReportData);

    void   setTotalTask(ms_int srcTotalTask);
    MSDict getScanResult();
public:
    ms_wstring explainationMsg;
    Observable<double> completePercentage;
    time_t startTime = std::time(nullptr);
    time_t endTime; 
    ms_int totalScannedFile = 0;
    ms_int totalAllowedFile = 0;
    ms_int totalSkippedByHash = 0;
    ms_int processedDataSize = 0;

private:
    std::mutex _mtx;

    std::atomic_int _totalBlockFile = 0; 
    MSDict _param {MSDictType::OBJECT};
    MSDict _pScanConfig {MSDictType::OBJECT};
    MSDict _blockedResults {MSDictType::OBJECT};
    MSDict _vulnarableResults {MSDictType::OBJECT};
    MSDict _skippedResults {MSDictType::OBJECT};
    MSDict _ignoredResults {MSDictType::OBJECT};
    MSDict _scanResult {MSDictType::OBJECT};
    std::set<ms_string> _errorMsgs;

    ms_int _totalTask;

    std::promise<ms_int> _tellEngineToStop;
}; 

#endif