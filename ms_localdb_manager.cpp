#include "ms_localdb_manager.h"
#include "ms_defines.h"
#include "utils/string_utils.h"
#include <iostream>

LocalDatabaseManager* LocalDatabaseManager::m_instance = nullptr;

LocalDatabaseManager::LocalDatabaseManager()
{
    SQLite::Database _db(StringUtils::toString(MS_LOCAL_DB_PATH), SQLite::OPEN_READWRITE | SQLite::OPEN_CREATE);
    _db.exec("CREATE TABLE IF NOT EXISTS " + TABLE_NAME +" (" + HASH_COLUMN_NAME + " TEXT PRIMARY KEY, " + RESULT_COLUMN_NAME + " TEXT, " + TTL_COLUMN_NAME + " INTERGER)");
}

LocalDatabaseManager::~LocalDatabaseManager()
{
}

LocalDatabaseManager* LocalDatabaseManager::instance()

{
    return m_instance ? m_instance : new LocalDatabaseManager();
}

ms_rc LocalDatabaseManager::queryLocalHash(const std::wstring &srcHash, std::wstring &result)
{
    std::lock_guard<std::mutex> lock(_queryMtx);
    try {
        // Open a connection to the database
        SQLite::Database _db(StringUtils::toString(MS_LOCAL_DB_PATH), SQLite::OPEN_READWRITE | SQLite::OPEN_CREATE);
        SQLite::Statement query(_db, "SELECT " + RESULT_COLUMN_NAME + " FROM " + TABLE_NAME + " WHERE " + HASH_COLUMN_NAME + " = ?");
        query.bind(1, StringUtils::toString(srcHash));

        if (query.executeStep()) {
            result = StringUtils::toWideString(query.getColumn(0).getText());
            // Process the retrieved result
            // std::cout << "Result for hash " << StringUtils::toString(srcHash) << ": " << StringUtils::toString(result) << std::endl;
            return MS_OK;
        }
        return MS_ERROR_ABORTED; 
    
    } catch (std::exception& e) {
        std::cout << "SQLite error: " << e.what() << std::endl;
        return MS_ERROR_ABORTED;
    }

}

ms_rc LocalDatabaseManager::saveLocalHash(const std::wstring &srcHash, const std::wstring &srcResult, int srcTtl)
{
    std::lock_guard<std::mutex> lock(_savingMtx);
    try {
        // // Insert data into the table
        SQLite::Database _db(StringUtils::toString(MS_LOCAL_DB_PATH), SQLite::OPEN_READWRITE | SQLite::OPEN_CREATE);
        SQLite::Statement query(_db, "INSERT INTO " + TABLE_NAME + " (" + HASH_COLUMN_NAME + ", " + RESULT_COLUMN_NAME + ", " + TTL_COLUMN_NAME + ") VALUES (?, ?, ?)");
        query.bind(1, StringUtils::toString(srcHash));
        query.bind(2, StringUtils::toString(srcResult));
        query.bind(3,srcTtl);
        query.exec();
        return MS_OK;
    } catch (std::exception& e) {
        std::cout << "SQLite error: " << e.what() << std::endl;
        return MS_ERROR_ABORTED;
    }
}


