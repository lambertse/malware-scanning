#include "ms_localdb_manager.h"
#include "ms_defines.h"
#include "ms_logger.h"
#include "utils/string_utils.h"
#include <iostream>

LocalDatabaseManager* LocalDatabaseManager::m_instance = nullptr;
std::mutex LocalDatabaseManager::_accessDB;

LocalDatabaseManager::~LocalDatabaseManager()
{
}

LocalDatabaseManager* LocalDatabaseManager::instance()
{
    std::lock_guard<std::mutex> lock(_accessDB);
    return m_instance ? m_instance : new LocalDatabaseManager();
}   

ms_rc LocalDatabaseManager::queryLocalResult(const std::wstring &srcHash, std::wstring &result)
{
    try {
        std::lock_guard<std::mutex> lock(_accessDB);
        // Open a connection to the database
        SQLite::Statement query(_db, "SELECT " + RESULT_COLUMN_NAME + " FROM " + TABLE_NAME + " WHERE " + HASH_COLUMN_NAME + " = ?");
        query.bind(1, StringUtils::toString(srcHash));

        if (query.executeStep()) {
            result = StringUtils::toWideString(query.getColumn(0).getText());
            // Process the retrieved result
            // std::cout << "Result for hash " << StringUtils::toString(srcHash) << ": " << StringUtils::toString(result) << std::endl;
            return MS_OK;
        }
        return MS_ERROR_ABORTED; 
    
    } catch (std::exception& e) {
        MS_LOGGER_ERROR("[local-database] query error: {}", e.what());
        return MS_ERROR_ABORTED;
    }

}

ms_rc LocalDatabaseManager::saveLocalResult(const std::wstring &srcHash, const std::wstring &srcResult, ms_int srcTtl)
{
    try {
        std::lock_guard<std::mutex> lock(_accessDB);
        // // Insert data into the table
        SQLite::Statement query(_db, "INSERT INTO " + TABLE_NAME + " (" + HASH_COLUMN_NAME + ", " + RESULT_COLUMN_NAME + ", " + TTL_COLUMN_NAME + ") VALUES (?, ?, ?)");
        query.bind(1, StringUtils::toString(srcHash));
        query.bind(2, StringUtils::toString(srcResult));
        query.bind(3,srcTtl);
        query.exec();
        return MS_OK;
    } catch (std::exception& e) {
        MS_LOGGER_ERROR("[local-database] save error: {}", e.what());
        return MS_ERROR_ABORTED;
    }
}


