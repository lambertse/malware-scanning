#ifndef __ms_slot_h__
#define __ms_slot_h__

#include <thread>
#include <condition_variable>
#include <mutex>
#include <unordered_set>
#include "utils/string_utils.h"
#include <iostream>
#include "ms_defines.h"

using ms_ll = size_t;

class Slot {
public:
    Slot(ms_ll srcLimitSize, int srcMaxThr) : _limitTotalSize(srcLimitSize), 
                                              _currentProcessingSize(0),
                                              _maxProcessingThread(srcMaxThr){}

    void waitUntilSlotAvailable(ms_ll fileSize, ms_wstring fileName){
        std::unique_lock<std::mutex> lock(_slotMtx);
        _slotCv.wait(lock, [this] { return _currentProcessingSize < _limitTotalSize && _currentProcessingThread < _maxProcessingThread; });
        _currentProcessingSize += fileSize;
        _currentProcessingThread++;
        // std::cout << "Add " << StringUtils::toString(fileName) << "  with " <<  fileSize << ", total: " << _currentProcessingSize <<std::endl;
    }
    void finishATask(ms_ll fileSize, ms_wstring fileName){
        std::unique_lock<std::mutex> lock(_slotMtx);
        _currentProcessingSize -= fileSize;
        _currentProcessingThread--;
        // std::cout << "Release " << StringUtils::toString(fileName) << "  with " <<  fileSize << ", total: " << _currentProcessingSize <<std::endl;
        _slotCv.notify_all();
    }
protected:
    std::mutex _slotMtx;
    std::condition_variable _slotCv;

    ms_ll _limitTotalSize;
    ms_ll _currentProcessingSize;

    int _currentProcessingThread;
    int _maxProcessingThread;
};

#endif