#include "ms_config.h"
#include "ms_defines.h"
#include "ms_return_codes.h"
#include "3rdparty/msdict/ms_json.h"

#ifndef _WIN32
    #include "axz_json.h"
    #include "axz_utils_bridge.h"
    #include "axz_methods.h"
    #include "axz_keys.h"
#endif
namespace{
namespace Internal
{
    ms_rc loadConfig(MSDict& media_security_config);
}
};

MalwareScanConfig* MalwareScanConfig::m_instance = nullptr;


MalwareScanConfig* MalwareScanConfig::instance(){
    if(!m_instance){
        m_instance = new MalwareScanConfig();
    }
    return m_instance;

}
void MalwareScanConfig::destroy() {
    if ( MalwareScanConfig::m_instance ) {
        delete MalwareScanConfig::m_instance;
        MalwareScanConfig::m_instance = nullptr;
    }
}
MalwareScanConfig::MalwareScanConfig(){
    _mediaSecurityConfig.become(MSDictType::NUL);
}

MalwareScanConfig::~MalwareScanConfig(){}

MSDict MalwareScanConfig::getConfig()
{
    // if(_mediaSecurityConfig.isNull() && MS_SUCCESS ( Internal::loadConfig(_mediaSecurityConfig))){
    //     return _mediaSecurityConfig;
    // }
    // _mediaSecurityConfig.become(MSDictType::NUL);
    // return _mediaSecurityConfig;
    return ms_dict_object{
        {L"sot_config", ms_dict_object{
                        {L"enabled",1},
                        {L"interval_s", 3600},
                        {L"waiting_time", ms_dict_object{
                            {L"interval", 5},
                            {L"tsr", 0}
                        }}}
                        },
        {L"scan_options", ms_dict_object{
            {L"type", ms_dict_array{0,1}},
            {L"path", L"/home/trile/Downloads"},
            {L"full_scan",0}
        }},
        {L"available_scanners", ms_dict_array{
            ms_dict_object{
                {L"type", 0},
                {L"server_id", L""},
                {L"url", L"https://api.metadefender.com:443/v4/"},
                {L"api_key", L"2acdcdfa5857b2aa585c2e3d47f2096c"},
                {L"scan_rule", ms_dict_object{
                            {L"user_agent",L""},
                            {L"rule", L""},
                            {L"include_engines", ms_dict_array{}}
                                }},
                {L"engine_threshold", 0}
            }
        }},
        {L"scanning_policy", ms_dict_object{
            {L"disable_hash_check",0}
        }}
    };
}


namespace
{
namespace Internal
{

#ifndef _WIN32
    ms_rc loadConfig(MSDict& media_security_config){
        ms_rc rc = MS_OK;
        AxzUtilsBridge bridge;

        axz_dict_array keys = { MS_KEY_MEDIA_SECURITY };

        axz_dict_object param = {
            { AXZ_KEY_CONFIG_KEYS, keys },            
        };

        axz_dict_object in_object = {
            { AXZ_KEY_MID, AXZ_MID_QUERY_CONFIG },
            { AXZ_KEY_PARAM, std::move( param )}
        };

        
        AxzDict returnDict = bridge.handle(std::move(in_object));
        ms_wstring returnStr;
        if ( MS_FAILED( rc = AxzJson::serialize(returnDict, returnStr)) ||
             MS_FAILED( rc = MSJson::deserialize(returnStr, media_security_config))){
                return rc;
        }
        return rc;
    }
#endif
}
};

