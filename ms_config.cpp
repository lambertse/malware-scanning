#include "ms_config.h"
#include "ms_defines.h"
#include "ms_return_codes.h"
#include "ms_logger.h"
#include "3rdparty/msdict/ms_json.h"
#include "utils/string_utils.h"
#include <iostream>
#include <thread>

#ifndef _WIN32
    #include "axz_json.h"
    #include "axz_utils_bridge.h"
    #include "axz_methods.h"
    #include "axz_keys.h"
#endif
namespace{
namespace Internal
{
    ms_rc loadConfig(MSDict& scanConfig);
}
};

MalwareScanConfig* MalwareScanConfig::m_instance = nullptr;


MalwareScanConfig* MalwareScanConfig::instance(){
    if(!m_instance){
        m_instance = new MalwareScanConfig();
    }
    return m_instance;

}
void MalwareScanConfig::destroy() {
    if ( MalwareScanConfig::m_instance ) {
        delete MalwareScanConfig::m_instance;
        MalwareScanConfig::m_instance = nullptr;
    }
}
MalwareScanConfig::MalwareScanConfig(){
    _scanConfig.become(MSDictType::NUL);
}

MalwareScanConfig::~MalwareScanConfig(){}

MSDict MalwareScanConfig::getConfig()
{

    if(_scanConfig.isNull()){
        if(  MS_FAILED ( Internal::loadConfig(_scanConfig))){
           MS_LOGGER_ERROR("Can not get config!");
        }

    }
    return _scanConfig;
}


namespace
{
namespace Internal
{

#ifndef _WIN32
    ms_rc loadConfig(MSDict& scanConfig){
        ms_rc rc = MS_OK;
        AxzUtilsBridge bridge;

        axz_dict_array keys = { MS_KEY_AVAIL_SCANNERS, MS_KEY_SCANNING_POLICY, MS_KEY_SCAN_OPTIONS };

        axz_dict_object param = {
            { AXZ_KEY_CONFIG_KEYS, keys },            
        };

        axz_dict_object in_object = {
            { AXZ_KEY_MID, AXZ_MID_QUERY_CONFIG },
            { AXZ_KEY_PARAM, std::move( param )}
        };

        
        AxzDict returnDict = bridge.handle(std::move(in_object));

        ms_wstring returnStr;
        MSDict returnMSDict;
        if ( MS_FAILED( rc = AxzJson::serialize(returnDict, returnStr)) ||
             MS_FAILED( rc = MSJson::deserialize(returnStr, returnMSDict)) ||
             MS_FAILED( rc = returnMSDict.val(MS_KEY_CONFIG, scanConfig) )){
                MS_LOGGER_ERROR("[config] Can not get config!");
                return rc;
        }
        return rc;
    }
#endif
}
};

