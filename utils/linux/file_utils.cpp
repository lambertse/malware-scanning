#include "../file_utils.h"
#include "../string_utils.h"
#include "file_utils_calhash.h"
#include <sys/stat.h>    
namespace
{
namespace Internal
{
    ms_rc mapCode( int in_err_no );
};
}

ms_rc FileUtils::fileSize( const std::wstring& in_file_path, size_t& out_size )
{               
    struct stat st;
    if ( stat( StringUtils::toString( in_file_path ).c_str(), &st ) < 0 )
    {
        out_size = 0;
        return Internal::mapCode( errno );
    }

    out_size = st.st_size;
    return MS_OK;    
}

std::ifstream FileUtils::getContent(const std::wstring &in_file_path, ms_rc &rc)
{
    std::ifstream is( StringUtils::toString( in_file_path ).c_str(), std::ifstream::binary );
    rc = MS_OK;
    return is;
}

ms_rc FileUtils::calculateHash(std::ifstream& in_content, std::wstring &sha256)
{
    MSUtilsShamd hasher( MSUtilsHashType::MS_SHA_256 );
    return hasher.hexCodeOfFile(in_content, sha256);
}

namespace
{
namespace Internal
{
    ms_rc mapCode( int in_err_no )
    {        
        switch ( in_err_no )
        {
            case 0:         return MS_OK;
            case EROFS:    
            case EACCES:    return MS_ERROR_ACCESS_DENIED;
            case ENOENT:
            case ENOTDIR:   return MS_ERROR_NOT_FOUND;            
        }
        return MS_ERROR_NATIVE_API;     
    }
}
}

