#include "ms_localhash_manager.h"
#include "ms_defines.h"
#include "shared/utils/string_util/StringUtils.h"
#include <iostream>

LocalHashManager* LocalHashManager::m_instance = nullptr;

LocalHashManager::LocalHashManager()
{
}

LocalHashManager::~LocalHashManager()
{
}

LocalHashManager* LocalHashManager::instance()

{
    return m_instance ? m_instance : new LocalHashManager();
}

ms_rc LocalHashManager::queryLocalHash(const std::wstring &srcHash, std::wstring &result)
{
    std::lock_guard<std::mutex> lock(_queryMtx);
    try {
        // Open a connection to the database
        SQLite::Database _db(StringUtils::toString(MS_LOCAL_DB_PATH), SQLite::OPEN_READWRITE | SQLite::OPEN_CREATE);
        _db.exec("CREATE TABLE IF NOT EXISTS local_hash_table (hash TEXT PRIMARY KEY, result TEXT)");
        SQLite::Statement query(_db, "SELECT result FROM local_hash_table WHERE hash = ?");
        query.bind(1, StringUtils::toString(srcHash));

        if (query.executeStep()) {
            result = StringUtils::toWideString(query.getColumn(0).getText());
            // Process the retrieved result
            // std::cout << "Result for hash " << StringUtils::toString(srcHash) << ": " << StringUtils::toString(result) << std::endl;
            return MS_OK;
        }
        return MS_ERROR_ABORTED; 
    
    } catch (std::exception& e) {
        std::cout << "SQLite error: " << e.what() << std::endl;
        return MS_ERROR_ABORTED;
    }

}

ms_rc LocalHashManager::saveLocalHash(const std::wstring &srcHash, const std::wstring &srcResult)
{
    std::lock_guard<std::mutex> lock(_savingMtx);
    try {
        // // Insert data into the table
        SQLite::Database _db(StringUtils::toString(MS_LOCAL_DB_PATH), SQLite::OPEN_READWRITE | SQLite::OPEN_CREATE);
        _db.exec("CREATE TABLE IF NOT EXISTS local_hash_table (hash TEXT PRIMARY KEY, result TEXT)");
        SQLite::Statement query(_db, "INSERT INTO local_hash_table (hash, result) VALUES (?, ?)");
        query.bind(1, StringUtils::toString(srcHash));
        query.bind(2, StringUtils::toString(srcResult));
        query.exec();
        return MS_OK;
    } catch (std::exception& e) {
        std::cout << "SQLite error: " << e.what() << std::endl;
        return MS_ERROR_ABORTED;
    }
}


