#ifndef __ms_layers_interface_h__
#define __ms_layers_interface_h__

#include "3rdparty/msdict/ms_dict.h"
#include "utils/string_utils.h"
#include <memory>
#include <iostream>
#include <thread>
#include <condition_variable>
#include <unordered_set>
#include <fstream>

using ms_ll = size_t;

class MalwareScanLayer;
using ms_shared_layer_ptr = std::shared_ptr<MalwareScanLayer>;

class MalwareScanLayer
{
public:
    MalwareScanLayer() : _nextStep(nullptr){}
    virtual ms_rc start(const MSDict& in_dict, MSDict& out_dict)
    {
        return this->_nextStep ? this->_nextStep->start(in_dict, out_dict) : MS_OK;
    }
    ms_shared_layer_ptr setNext(ms_shared_layer_ptr srcNext)
    {
        _nextStep = srcNext;
        return _nextStep;
    }

protected:
    class FileScanInfo{
    public:
        std::wstring _fileName;
        std::ifstream _streams;
        size_t _size;
    } _scanInfo;
    ms_shared_layer_ptr _nextStep;

};

class Slot {
public:
    Slot(ms_ll srcLimitSize) : _limitTotalSize(srcLimitSize), _currentProcessingSize(0){}

    void waitUntilSlotAvailable(ms_ll fileSize, std::wstring fileName) {
        std::unique_lock<std::mutex> lock(_slotMtx);
        _slotCv.wait(lock, [this] { return _currentProcessingSize < _limitTotalSize; });
        _currentProcessingSize += fileSize;
        _listProcessingFile.insert(fileName);
        std::cout << "Add " << StringUtils::toString(fileName) << "  with " <<  fileSize << ", total: " << _currentProcessingSize <<std::endl;
    }

    // Call this function when _currentProcessingSize changes.
    void finishATask(ms_ll fileSize, std::wstring fileName) {
        std::unique_lock<std::mutex> lock(_slotMtx);
        _currentProcessingSize -= fileSize;
        _listProcessingFile.erase(fileName);
        std::cout << "Release " << StringUtils::toString(fileName) << "  with " <<  fileSize << ", total: " << _currentProcessingSize <<std::endl;
        _slotCv.notify_all();
    }
    ms_ll getCurrentProcessingSize(){
        for(const std::wstring& i : _listProcessingFile){
            std::cout << StringUtils::toString(i) << ", ";
        }
    }
private:
    
    std::mutex _slotMtx;
    std::condition_variable _slotCv;

    ms_ll _limitTotalSize;
    ms_ll _currentProcessingSize;
    std::unordered_set<std::wstring> _listProcessingFile;
};



#endif