# Device Scanning module
cmake_minimum_required( VERSION 3.5.0 )
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

project( malwarescan )
if ( MSVC )
    add_definitions( -DMSCUS_EXPORT -DUNICODE )
endif()

#linux
include_directories( ${CROSS_PLATFORM_PATH})
include_directories( ${SHARED_INCLUDED_PATH})
include_directories( ${3RDPARTY_PATH}/cpr/include)
include_directories( ${3RDPARTY_PATH}/spdlog/include)
include_directories( ${3RDPARTY_PATH}/SQLiteCpp/include)
include_directories( ${CMAKE_SOURCE_DIR}/3rdparty/curl/include)
include_directories( ${CMAKE_SOURCE_DIR}/3rdparty/openssl/include )

include_directories( ${CMAKE_SOURCE_DIR}/agent/core/axzutils )
include_directories( ${CMAKE_SOURCE_DIR}/common )
include_directories( ${CMAKE_SOURCE_DIR}/shared/axzscu )
include_directories( ${CMAKE_SOURCE_DIR}/shared/axzdict )
include_directories( ${CMAKE_CURRENT_LIST_DIR})
set( MS_DICT_DIR        ${CMAKE_CURRENT_SOURCE_DIR}/msdict)
set( MS_PATH_FINDER_DIR ${CMAKE_CURRENT_SOURCE_DIR}/path_finder)

include_directories(
    ${MS_DICT_DIR}
    ${MS_PATH_FINDER_DIR}
)

set(MS_DICT_HEADER 
    msdict/ms_dict_stepper.h
    msdict/ms_dict.h
    msdict/ms_json.h
    msdict/ms_native.h
    msdict/ms_types.h)
set(MS_DICT_SOURCE
    msdict/ms_dict.cpp
    msdict/ms_json.cpp )
set(MS_FINDER_HEADER 
    path_finder/FinderDefines.h
    path_finder/FinderFactory.h
    path_finder/PathFinder.h
    path_finder/MemoryFinderCore.h
    path_finder/OesisFinderCore.h
    path_finder/RegularFinderCore.h)
set(MS_FINDER_SOURCE 
    path_finder/linux/MemoryFinderCore.cpp
    path_finder/linux/OesisFinderCore.cpp
    path_finder/linux/RegularFinderCore.cpp
    path_finder/FinderFactory.cpp
    path_finder/PathFinder.cpp)
set(MS_PROJECT_HEADER
    ms_logger.h
    ms_scan_task.h
    ms_engine.h
    ms_return_codes.h
    ms_threadpool.h
    ms.h
    ms_slot.h
    ms_server_connection.h
    ms_layers.h
    ms_config.h
    ms_export.h
    ms_buildrp_listener.h
    ms_defines.h
    ms_layers_abstract.h
    ms_labels.h
    ms_localdb_manager.h
)
set(MS_PROJECT_SOURCE
    ms_engine.cpp
    ms_threadpool.cpp
    ms_localdb_manager.cpp
    ms_scan_task.cpp
    ms_config.cpp
    ms_buildrp_listener.cpp
    ms.cpp
    ms_server_connection.cpp)
set(MS_UTILS_HEADER
    utils/string_utils.h
    utils/cpr_template_utils.h
    utils/cpr_utils.h
    utils/file_utils.h
    utils/linux/file_utils_calhash.h)
set(MS_UTILS_SOURCE
    utils/cpr_utils.cpp
    utils/linux/string_utils.cpp
    utils/linux/file_utils.cpp
)
# for dependent library linked
link_directories (${CMAKE_ARCHIVE_OUTPUT_DIRECTORY} )
link_directories (${CMAKE_LIBRARY_OUTPUT_DIRECTORY} )

source_group("Header Files/internal_curl" FILES ${MS_DICT_HEADER})
source_group("Header Files/internal_curl" FILES ${MS_FINDER_HEADER})
source_group("Header Files/internal_curl" FILES ${MS_PROJECT_HEADER})
source_group("Header Files/internal_curl" FILES ${MS_UTILS_HEADER})

source_group("Source Files/step_executors" FILES ${MS_DICT_SOURCE})
source_group("Source Files/step_executors" FILES ${MS_FINDER_SOURCE})
source_group("Source Files/step_executors" FILES ${MS_PROJECT_SOURCE})
source_group("Source Files/step_executors" FILES ${MS_UTILS_SOURCE})

add_library( ${PROJECT_NAME} SHARED 
    ${MS_DICT_HEADER}
    ${MS_DICT_SOURCE}   
    ${MS_FINDER_HEADER}
    ${MS_FINDER_SOURCE}
    ${MS_PROJECT_HEADER}
    ${MS_PROJECT_SOURCE}
    ${MS_UTILS_HEADER}
    ${MS_UTILS_SOURCE}
)

# for headers included
# set( MS_DICT_DIR        ${CMAKE_CURRENT_SOURCE_DIR}/msdict)
# set( MS_PATH_FINDER_DIR ${CMAKE_CURRENT_SOURCE_DIR}/path_finder)

# include_directories(
#     ${MS_DICT_DIR}
#     ${MS_PATH_FINDER_DIR}
# )


# # for module sources
# file( GLOB LIB_SCN_SOURCES 
#     *.cpp 
#     path_finder/*.cpp 
#     path_finder/linux/*.cpp 
#     msdict/*.cpp
#     utils/*/*.cpp
#     utils/*.cpp)

# do generate shared library
#  SHARED ${LIB_SCN_SOURCES} )

# do link dependent libraries
set( MS_LINKED_LIBS  maf  cpr::cpr spdlog 
)

#link for linux
target_link_libraries( ${PROJECT_NAME} axzscu axzdct axzutls )

target_link_libraries( ${PROJECT_NAME} ${MS_LINKED_LIBS} )
target_link_libraries( ${PROJECT_NAME} SQLiteCpp sqlite3 pthread dl stdc++fs )
        
target_link_libraries(${PROJECT_NAME} ${CMAKE_SOURCE_DIR}/3rdparty/curl/lib/x64/libcurl.so )
target_link_libraries(${PROJECT_NAME} ${CMAKE_SOURCE_DIR}/3rdparty/openssl/lib/x64/libcrypto.so )
target_link_libraries(${PROJECT_NAME} ${CMAKE_SOURCE_DIR}/3rdparty/openssl/lib/x64/libssl.so )




    
# for version
set_target_properties( ${PROJECT_NAME} PROPERTIES VERSION ${AXZ_AGENT_VERSION_STRING} )