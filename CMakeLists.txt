# Malware Scanning module
cmake_minimum_required( VERSION 3.15 )
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

project( malwarescan )
if ( MSVC )
    add_definitions( -DMSCUS_EXPORT -DUNICODE )
endif()

include_directories(include)
include_directories(src)
include_directories( ${CROSS_PLATFORM_PATH})
include_directories( ${SHARED_INCLUDED_PATH})
include_directories( ${3RDPARTY_PATH}/cpr/include)
include_directories( ${3RDPARTY_PATH}/spdlog/include)
include_directories( ${3RDPARTY_PATH}/SQLiteCpp/include)
include_directories( ${CMAKE_SOURCE_DIR}/3rdparty/curl/include)
include_directories( ${CMAKE_SOURCE_DIR}/3rdparty/openssl/include )
set( INTERNAL_FOLDER ${CMAKE_CURRENT_SOURCE_DIR}/include/msdict 
                     ${CMAKE_CURRENT_SOURCE_DIR}/include/path_finder
                     ${CMAKE_CURRENT_SOURCE_DIR}/include/utils)
include_directories( ${INTERNAL_FOLDER})

if(WIN32)

elseif(APPLE)

else()
    #linux 
    include_directories( ${CMAKE_SOURCE_DIR}/agent/core/axzutils )
    include_directories( ${CMAKE_SOURCE_DIR}/common )
    include_directories( ${CMAKE_SOURCE_DIR}/shared/axzscu )
    include_directories( ${CMAKE_SOURCE_DIR}/shared/axzdict )
endif()

set(MS_DICT_HEADER 
    include/msdict/ms_dict_stepper.h
    include/msdict/ms_dict.h
    include/msdict/ms_json.h
    include/msdict/ms_native.h
    include/msdict/ms_types.h)

set(MS_FINDER_HEADER 
    include/path_finder/FinderDefines.h
    include/path_finder/FinderFactory.h
    include/path_finder/PathFinder.h
    include/path_finder/MemoryFinderCore.h
    include/path_finder/OesisFinderCore.h
    include/path_finder/RegularFinderCore.h)

set(MS_UTILS_HEADER
    include/utils/string_utils.h
    include/utils/cpr_template_utils.h
    include/utils/cpr_utils.h
    include/utils/file_utils.h
    include/utils/file_utils_calhash.h)

set(MS_PROJECT_HEADER
    include/ms_logger.h
    include/ms_scan_task.h
    include/ms_engine.h
    include/ms_return_codes.h
    include/ms_threadpool.h
    include/ms.h
    include/ms_slot.h
    include/ms_server_connection.h
    include/ms_layers.h
    include/ms_config.h
    include/ms_export.h
    include/ms_buildrp_listener.h
    include/ms_defines.h
    include/ms_layers_abstract.h
    include/ms_labels.h
    include/ms_localdb_manager.h
)
set(MS_DICT_SOURCE
    src/msdict/ms_dict.cpp
    src/msdict/ms_json.cpp )
    
set(MS_FINDER_SOURCE 
    src/path_finder/linux/MemoryFinderCore.cpp
    src/path_finder/linux/OesisFinderCore.cpp
    src/path_finder/linux/RegularFinderCore.cpp
    src/path_finder/FinderFactory.cpp
    src/path_finder/PathFinder.cpp)

set(MS_PROJECT_SOURCE
    src/ms_engine.cpp
    src/ms_threadpool.cpp
    src/ms_localdb_manager.cpp
    src/ms_scan_task.cpp
    src/ms_config.cpp
    src/ms_buildrp_listener.cpp
    src/ms.cpp
    src/ms_server_connection.cpp)

set(MS_UTILS_SOURCE
    src/utils/cpr_utils.cpp
    src/utils/linux/string_utils.cpp
    src/utils/linux/file_utils.cpp
)
set(MS_EXTERNAL_HEADER
    ${SHARED_INCLUDED_PATH}/shared/logging/DefaultLogger.h
)
set(MS_EXTERNAL_SOURCE
    ${SHARED_SOURCE_PATH}/logging/DefaultLogger.cpp
)
# for dependent library linked
link_directories (${CMAKE_ARCHIVE_OUTPUT_DIRECTORY} )
link_directories (${CMAKE_LIBRARY_OUTPUT_DIRECTORY} )

source_group("Header Files/dict"        FILES ${MS_DICT_HEADER})
source_group("Header Files/path_finder" FILES ${MS_FINDER_HEADER})
source_group("Header Files/utils"       FILES ${MS_UTILS_HEADER})
source_group("Header Files/external"    FILES ${MS_EXTERNAL_HEADER})   

source_group("Source Files/dict"        FILES ${MS_DICT_SOURCE})
source_group("Source Files/path_finder" FILES ${MS_FINDER_SOURCE})
source_group("Source Files/utils"       FILES ${MS_UTILS_SOURCE})
source_group("Source Files/external"    FILES ${MS_EXTERNAL_SOURCE})

add_library( ${PROJECT_NAME} SHARED 
    ${MS_DICT_HEADER}
    ${MS_DICT_SOURCE}   
    ${MS_FINDER_HEADER}
    ${MS_FINDER_SOURCE}
    ${MS_PROJECT_HEADER}
    ${MS_PROJECT_SOURCE}
    ${MS_UTILS_HEADER}
    ${MS_UTILS_SOURCE}
    ${MS_EXTERNAL_HEADER}
    ${MS_EXTERNAL_SOURCE}
)

if (NOT WIN32 AND NOT APPLE )
    #link for linux
    target_link_libraries( ${PROJECT_NAME} PRIVATE axzscu axzdct axzutls )
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/3rdparty/curl/lib/x64/libcurl.so )
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/3rdparty/openssl/lib/x64/libcrypto.so )
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CMAKE_SOURCE_DIR}/3rdparty/openssl/lib/x64/libssl.so )
endif()

target_link_libraries( ${PROJECT_NAME} PRIVATE SQLiteCpp sqlite3 pthread dl maf cpr::cpr spdlog)
target_include_directories(${PROJECT_NAME} INTERFACE ${CMAKE_CURRENT_SOURCE_DIR}/include)
# for version
set_target_properties( ${PROJECT_NAME} PROPERTIES VERSION ${AXZ_AGENT_VERSION_STRING} )