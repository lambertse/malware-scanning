#ifndef __ms_localdb_manager_h__
#define __ms_localdb_manager_h__

#include "3rdparty/SQLiteCpp/include/SQLiteCpp/SQLiteCpp.h"
#include "utils/string_utils.h"
#include "ms_defines.h"
#include "ms_return_codes.h"
#include <thread>
#include <mutex>


struct FileInfo
{
    ms_string hash;
    ms_string scanResults;
    ms_int ttl = 0;
};

static const ms_string TABLE_NAME = "SCANRESULTS";
static const ms_string HASH_COLUMN_NAME = "HASH";
static const ms_string RESULT_COLUMN_NAME = "RESULTS";
static const ms_string TTL_COLUMN_NAME = "TTL";

class LocalDatabaseManager
{
public:
    static LocalDatabaseManager* instance();
    LocalDatabaseManager( const LocalDatabaseManager& ) = delete;
    LocalDatabaseManager( LocalDatabaseManager&& ) = delete;
    LocalDatabaseManager& operator=( const LocalDatabaseManager& ) = delete;
    LocalDatabaseManager& operator=( LocalDatabaseManager&& ) = delete;

    ms_rc queryLocalResult(const std::wstring& srcHash, std::wstring& result);
    ms_rc saveLocalResult(const std::wstring& srcHash, const std::wstring& srcResult, ms_int srcTtl);

private:
    LocalDatabaseManager() : _db(StringUtils::toString(MS_PATH_LOCAL_DB_PATH), SQLite::OPEN_READWRITE | SQLite::OPEN_CREATE){
        _db.exec("CREATE TABLE IF NOT EXISTS " + TABLE_NAME +" (" + HASH_COLUMN_NAME + " TEXT PRIMARY KEY, " + RESULT_COLUMN_NAME + " TEXT, " + TTL_COLUMN_NAME + " INTERGER)");
    }
    
    ~LocalDatabaseManager();
    
    SQLite::Database _db;
    static std::mutex _accessDB;
    static LocalDatabaseManager* m_instance;
};


#endif