#ifndef __ms_h__
#define __ms_h__

#include "ms_engine.h" 
#include "msdict/ms_json.h"

enum TriggerEventSource
{
    BY_TIMEOUT,
    BY_ONDEMAND_REMOTE_COMMAND,
};

// MS_DECLSPEC class EngineManager{
// public:
//     EngineManager(ms_int srcEvent, std::shared_ptr<std::promise<ms_bool>> srcPromise, ms_wstring srcOption = L"") : _event(srcEvent), _buildRPFinish(srcPromise){
//         MSDict scanOptions{MSDictType::NUL};
//         if(!srcOption.empty()){
//             MSJson::deserialize(srcOption, scanOptions);
//         }
//         _engine = std::make_shared<MalwareScanEngine>(_event, scanOptions);
//     }
//     ~EngineManager(){}

//     ms_rc init();
//     ms_rc start();
//     ms_rc deinit();

//     ms_wstring getScanResult();
//     ms_int getActionResult();
//     ms_wstring getExplanationResult();
//     ms_wstring getServerID();

// private:
//     std::shared_ptr<std::promise<ms_bool>>  _buildRPFinish;
//     ms_shared_engine                        _engine; 
//     ms_int                                  _event; //0: scheduler, 1: ondemand
//     MSDict                                  _additionalData;
//     MSDict                                  _scanResultData;
// };

// using ms_shared_engine_manager = std::shared_ptr<EngineManager>;
using EngineQueue = std::list<ms_shared_engine>;

MS_DECLSPEC class MalwareScanManager
{
public:

    static MalwareScanManager* instance();

    ms_rc init();
    ms_rc start();
    bool addScanTask(ms_shared_engine srcEngine);
    void onEngineFinish(ms_shared_engine srcEngine);

    MalwareScanManager( const MalwareScanManager& ) = delete;
    MalwareScanManager( MalwareScanConfig&& ) = delete;
    MalwareScanManager& operator=( const MalwareScanManager& ) = delete;
    MalwareScanManager& operator=( MalwareScanManager&& ) = delete;

    ~MalwareScanManager(){}
private:
    MalwareScanManager() {}
private:
    static MalwareScanManager*       _instance;
    EngineQueue                      _engineQueue;
    ms_bool                          _sotEnabled;
    std::mutex                       _mutex;
};

#endif