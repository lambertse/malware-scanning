#pragma once
#include <maf/utils/Observable.h>
// #include <3rdpartycore/ExportDef.h>

#include <atomic>
#include <map>
#include <mutex>

#include "FinderDefines.h"

namespace owc {
namespace finder {
class PathFinder;
using FinderPtr = std::shared_ptr<PathFinder>;
using LargeSize = unsigned long;
class PathFinder {
 public:
  using ObservableState =
      maf::signal_slots::SharedMutexObservable<finder::State>;
  using FileCountCallback = std::function<void(LargeSize totalFiles)>;

   virtual ~PathFinder();

   virtual bool start(std::function<void(finder::State)> cb = {});
   virtual void stop();
   virtual void pause();
   virtual void resume();

   virtual LargeSize getTotalFileCount() = 0;
   virtual void getTotalFileCount(FileCountCallback callback) = 0;
   virtual LargeSize getTotalFileCount(const Path& path, const finder::Options& options, uint32_t threadCount = 1) = 0;

   virtual bool accesible(
       const Path& path, int& error) = 0;
   virtual void setOptions(const finder::Options& options);


   ObservableState& state();
   finder::Type type() const;
   void setPathToFind(const Paths& multiPath);
   void setPathToFind(const Path& path);
   void registerFoundCallback(finder::FoundCallback foundCallback);
   void registerFinishedCallback(
      std::function<void()> finishedCallback);
   void reigsterAbortedCallback(
      std::function<void()> abortedCallback);

 protected:
  std::shared_ptr<std::recursive_mutex> mtx_;
  std::unique_ptr<ObservableState> state_;
  std::vector<std::thread> asyncThreads_;
  Paths multiPath_;
  finder::FoundCallback foundCallback_;
  std::condition_variable conditionVarible_;
  std::function<void()> finishedCallback_;
  std::function<void()> abortedCallback_;
  finder::Options options_;
  finder::Type type_;
  std::vector<std::shared_ptr<FoundPathInfo>> parentDirs_;

  PathFinder();
  PathFinder(std::shared_ptr<std::recursive_mutex> mtx);

  virtual void explorePath(const Path& path) = 0;

  void checkState();
  void setState(finder::State state);
  void onFileFound(FoundPathConstInfoPtr path);
  void callSuitablyCallback();

 private:
  std::mutex changeStateMutex_;
};
}  // namespace finder
}  // namespace owc
