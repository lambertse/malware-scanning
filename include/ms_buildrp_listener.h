#ifndef __ms_buildrp_task_h__
#define __ms_buildrp_task_h__

#include "ms_layers_abstract.h"
#include "ms_config.h"
#include "ms_defines.h"
#include <maf/utils/Observable.h>
#include <mutex>
#include <atomic>

using namespace maf::signal_slots;

enum ScanResultStatus
{
    FAILED = 0,
    SUCCESS = 1,
    PARTIAL_SUCCESS = 2
};

enum FileScanConclusion{
  NoThreatDetected = 0,
  Infected = 1,
  Suspicious = 2,
  Failed = 3,
  CleanedDeleted = 4,
  Unknown = 5,
  Quarantined = 6,
  Whitelisted = 7,
  Blacklisted = 8,
  ExceededArchiveDepth = 9,
  NotScanned = 10,
  EncryptedArchive = 12,
  ExceededArchiveSize = 13,
  ExceededArchiveFileNumber = 14,
  PasswordProtectedDocument = 15,
  ExceededArchiveTimeout = 16,
  FiletypeMismatch = 17,
  PotentiallyVulnerableFile = 18,
  Canceled = 19,
  Sensitivedatafound = 20,
  YaraRuleMatched = 21,
  InProgress = 255,
  LP_LocalProcessResultStart = 1000,
  LP_ExceededFileSize = 1001
};

enum FileScanStatus {
  AllowedFile,
  BlockedFile,
  SkippedFile,
  VulnerableFile,
  ErrorFile
};

class MalwareScanBuildRP{
public:
    MalwareScanBuildRP(std::promise<ms_int> srcPromise) :  _totalTask(-1), _tellEngineToStop(std::move(srcPromise)){
        _pScanConfig = MalwareScanConfig::instance()->getConfig();
    }
    ~MalwareScanBuildRP();
    
    MSDict onNewFileScanned( MSDict file_result);
    ms_rc  onScanFinished();
    ms_rc  onNewFileProcessed(const size_t& fileSize);
    ms_rc  onNewBlockResult( MSDict file_result);
    ms_rc  onErrorResult( MSDict file_result);

    ms_rc  isBlockedResult(const MSDict &result, ms_bool &isBlock);
    ms_rc  isErrorResult(const MSDict &result, ms_bool &isBlock);

    ms_rc  filterIgnoredResults();    
    ms_rc  buildScanReport();
    ms_rc  createSOTReport(MSDict& sotReportData);

    void   setTotalTask(ms_int srcTotalTask);
    MSDict getScanResult();
    ScanResultStatus getActionResult();
public:
    ms_wstring explainationMsg;
    Observable<double> completePercentage;
    time_t startTime = std::time(nullptr);
    time_t endTime; 
    ms_int totalScannedFile     = 0;
    ms_int totalAllowedFile     = 0;
    ms_int totalSkippedByHash   = 0;
    ms_int processedDataSize    = 0;

private:
    std::mutex                          _mtx;

    MSDict                              _param {MSDictType::OBJECT};
    MSDict                              _pScanConfig {MSDictType::OBJECT};
    MSDict                              _blockedResults {MSDictType::OBJECT};
    MSDict                              _vulnarableResults {MSDictType::OBJECT};
    MSDict                              _skippedResults {MSDictType::OBJECT};
    MSDict                              _ignoredResults {MSDictType::OBJECT};
    MSDict                              _scanResult {MSDictType::OBJECT};
    ScanResultStatus                    _actionResult;
    std::set<ms_string>                 _errorMsgs;

    ms_int                              _totalTask;
    std::promise<ms_int>                _tellEngineToStop;
}; 

#endif